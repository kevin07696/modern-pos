# S2.1: Proto Contract Enhancements - Modifiers

**Sprint**: 2
**Story Points**: 3
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.5 (Item Service Proto)

---

## User Story

As a **developer**, I want **enhanced modifier proto contracts** so that **we can support complex modifier rules and validation**.

---

## Description

Extend the Item Management Service proto contracts to support advanced modifier features including conditional modifiers, nested modifiers, and comprehensive validation rules. This enables complex menu configurations like "Extra Cheese only available for Large pizzas".

---

## Acceptance Criteria

- [ ] ModifierOption includes availability rules
- [ ] ModifierGroup supports min/max selection constraints
- [ ] ModifierSection includes conditional display logic
- [ ] Nested modifier support added
- [ ] Price adjustment types (fixed, percentage)
- [ ] All fields documented with examples
- [ ] Proto linting passes
- [ ] Code generation successful
- [ ] Backward compatible with Sprint 1

---

## Definition of Done

- [x] Proto file updated in `item/v1/item_service.proto`
- [x] All new fields documented
- [x] Validation rules specified
- [x] Example requests/responses provided
- [x] Buf lint passing
- [x] Go code compiles
- [x] TypeScript code compiles
- [x] Code reviewed and approved

---

## Technical Details

### Enhanced Modifier Messages

```protobuf
// Enhanced ModifierSection with conditional logic
message ModifierSection {
  string id = 1;
  common.v1.LocalizedString name = 2;
  common.v1.LocalizedString description = 3;
  int32 min_selection = 4;
  int32 max_selection = 5;
  bool required = 6;
  repeated ModifierGroup groups = 7;
  
  // Sprint 2 additions
  ModifierAvailability availability = 8;
  bool allow_multiple_groups = 9;
  int32 display_order = 10;
  bool active = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

// Enhanced ModifierGroup with selection rules
message ModifierGroup {
  string id = 1;
  string section_id = 2;
  common.v1.LocalizedString name = 3;
  int32 display_order = 4;
  repeated ModifierOption options = 5;
  
  // Sprint 2 additions
  ModifierSelectionType selection_type = 6;
  int32 min_options = 7;
  int32 max_options = 8;
  bool default_selected = 9;
  bool active = 10;
  google.protobuf.Timestamp created_at = 11;
}

// Enhanced ModifierOption with conditional availability
message ModifierOption {
  string id = 1;
  string group_id = 2;
  common.v1.LocalizedString name = 3;
  
  // Price adjustments
  PriceAdjustment price_adjustment = 4;
  
  int32 display_order = 5;
  
  // Sprint 2 additions
  ModifierAvailability availability = 6;
  bool stockable = 7;
  int32 stock_quantity = 8;
  repeated string requires_options = 9;  // Conditional: requires these options selected first
  repeated string excludes_options = 10; // Mutually exclusive with these options
  bool active = 11;
  google.protobuf.Timestamp created_at = 12;
}

message PriceAdjustment {
  PriceAdjustmentType type = 1;
  common.v1.Money fixed_amount = 2;      // For FIXED type
  common.v1.Percentage percentage = 3;   // For PERCENTAGE type
}

enum PriceAdjustmentType {
  PRICE_ADJUSTMENT_TYPE_UNSPECIFIED = 0;
  PRICE_ADJUSTMENT_TYPE_FIXED = 1;       // +$2.00, -$1.00
  PRICE_ADJUSTMENT_TYPE_PERCENTAGE = 2;  // +10%, -5%
}

enum ModifierSelectionType {
  MODIFIER_SELECTION_TYPE_UNSPECIFIED = 0;
  MODIFIER_SELECTION_TYPE_SINGLE = 1;     // Radio button (only one)
  MODIFIER_SELECTION_TYPE_MULTIPLE = 2;   // Checkboxes (multiple)
}

message ModifierAvailability {
  repeated string item_ids = 1;           // Only available for these items
  repeated string category_ids = 2;       // Only available for items in these categories
  TimeRange time_range = 3;               // Time-based availability
  repeated int32 days_of_week = 4;        // 0=Sunday, 6=Saturday
}

message TimeRange {
  string start_time = 1;  // "11:00:00"
  string end_time = 2;    // "22:00:00"
}
```

---

## Implementation Steps

1. Open `proto/item/v1/item_service.proto`
2. Add PriceAdjustment message
3. Add PriceAdjustmentType enum
4. Add ModifierSelectionType enum
5. Add ModifierAvailability message
6. Add TimeRange message
7. Update ModifierSection with new fields
8. Update ModifierGroup with selection rules
9. Update ModifierOption with conditional logic
10. Add comprehensive documentation
11. Run `make proto-lint`
12. Run `make proto-generate`
13. Test Go compilation
14. Test TypeScript compilation

---

## Testing

### Test 1: Proto Validation
```bash
make proto-lint
# Expected: No errors

make proto-generate
# Expected: Code generated successfully
```

### Test 2: Go Compilation
```go
package main

import itemv1 "github.com/modernpos/pos/gen/proto/go/item/v1"

func main() {
    option := &itemv1.ModifierOption{
        Id:   "opt-1",
        Name: &commonv1.LocalizedString{Translations: map[string]string{"en-US": "Extra Cheese"}},
        PriceAdjustment: &itemv1.PriceAdjustment{
            Type:        itemv1.PriceAdjustmentType_PRICE_ADJUSTMENT_TYPE_FIXED,
            FixedAmount: &commonv1.Money{Amount: 200, CurrencyCode: "USD"},
        },
        Availability: &itemv1.ModifierAvailability{
            ItemIds: []string{"item-large-pizza"},
        },
    }
    _ = option
}
```

---

## Time Estimate

**Estimated**: 2 hours (proto updates) + 1 hour (testing)
**Actual**: ___ hours

---

## Notes

- Backward compatible with Sprint 1 (all new fields are optional or have defaults)
- Conditional modifiers enable complex menu rules
- Price adjustment types support both fixed and percentage pricing
- Availability rules enable time-based and item-specific modifiers
- Stock tracking for modifier options supports inventory management

---

## Related Stories

- **S1.5**: Define Proto Contracts - Item Service (prerequisite)
- **S2.2**: Implement Modifier Selection Logic (uses these contracts)
- **S2.3**: Modifier Validation Service (validates these rules)
- **S2.10**: POS Terminal - Modifier Selection UI (consumes these contracts)
