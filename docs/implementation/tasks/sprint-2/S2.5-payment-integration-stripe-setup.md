# S2.5: Payment Integration - Stripe Setup

**Sprint**: 2
**Story Points**: 3
**Assignee**: Developer A
**Priority**: P0 - Critical
**Dependencies**: S1.10 (Process Cash Payment)

---

## User Story

As a **developer**, I want **Stripe payment gateway integration configured** so that **we can process card payments securely**.

---

## Description

Set up Stripe payment gateway integration including API keys, webhook endpoints, and test mode configuration. This foundational setup enables card payment processing in subsequent stories.

---

## Acceptance Criteria

- [ ] Stripe account created (test mode)
- [ ] API keys stored securely in environment variables
- [ ] Stripe Go SDK integrated
- [ ] Webhook endpoint configured
- [ ] Webhook signature verification implemented
- [ ] Test payment successful
- [ ] Error handling for Stripe API failures
- [ ] Logging configured for payment events

---

## Definition of Done

- [x] Stripe SDK installed and configured
- [x] Environment variables set up
- [x] Webhook endpoint created
- [x] Signature verification working
- [x] Integration tests with Stripe test mode
- [x] Documentation updated with setup instructions
- [x] Code reviewed and approved

---

## Technical Details

### Environment Configuration

```bash
# .env
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_API_VERSION=2023-10-16
```

### Stripe Client Setup

```go
// services/order-fulfillment/internal/payment/stripe_client.go

package payment

import (
    "github.com/stripe/stripe-go/v76"
    "github.com/stripe/stripe-go/v76/paymentintent"
    "github.com/stripe/stripe-go/v76/webhook"
)

type StripeClient struct {
    apiKey        string
    webhookSecret string
}

func NewStripeClient(apiKey, webhookSecret string) *StripeClient {
    stripe.Key = apiKey
    return &StripeClient{
        apiKey:        apiKey,
        webhookSecret: webhookSecret,
    }
}

func (c *StripeClient) CreatePaymentIntent(amount int64, currency string, metadata map[string]string) (*stripe.PaymentIntent, error) {
    params := &stripe.PaymentIntentParams{
        Amount:   stripe.Int64(amount),
        Currency: stripe.String(currency),
    }
    
    // Add metadata for tracking
    for key, value := range metadata {
        params.AddMetadata(key, value)
    }
    
    return paymentintent.New(params)
}

func (c *StripeClient) VerifyWebhookSignature(payload []byte, signature string) (stripe.Event, error) {
    return webhook.ConstructEvent(payload, signature, c.webhookSecret)
}
```

### Webhook Endpoint

```go
// services/order-fulfillment/internal/handlers/webhook_handler.go

func (h *WebhookHandler) HandleStripeWebhook(w http.ResponseWriter, r *http.Request) {
    payload, err := io.ReadAll(r.Body)
    if err != nil {
        http.Error(w, "Failed to read request body", http.StatusBadRequest)
        return
    }
    
    signature := r.Header.Get("Stripe-Signature")
    
    event, err := h.stripeClient.VerifyWebhookSignature(payload, signature)
    if err != nil {
        log.Printf("Webhook signature verification failed: %v", err)
        http.Error(w, "Invalid signature", http.StatusUnauthorized)
        return
    }
    
    switch event.Type {
    case "payment_intent.succeeded":
        h.handlePaymentSucceeded(event)
    case "payment_intent.payment_failed":
        h.handlePaymentFailed(event)
    default:
        log.Printf("Unhandled event type: %s", event.Type)
    }
    
    w.WriteHeader(http.StatusOK)
}
```

### Database Schema Addition

```sql
-- Add Stripe-specific fields to sale_payments table
ALTER TABLE sale_payments
ADD COLUMN stripe_payment_intent_id VARCHAR(255),
ADD COLUMN stripe_charge_id VARCHAR(255),
ADD COLUMN stripe_customer_id VARCHAR(255);

CREATE INDEX idx_sale_payments_stripe_pi ON sale_payments(stripe_payment_intent_id);
```

---

## Implementation Steps

1. Create Stripe account (test mode)
2. Install Stripe Go SDK: `go get github.com/stripe/stripe-go/v76`
3. Add environment variables to `.env`
4. Create StripeClient wrapper
5. Implement CreatePaymentIntent method
6. Create webhook endpoint handler
7. Implement webhook signature verification
8. Add database migrations for Stripe fields
9. Write integration tests with Stripe test mode
10. Test webhook delivery with Stripe CLI
11. Document setup process

---

## Testing

### Integration Test with Stripe Test Mode

```go
func TestStripeClient_CreatePaymentIntent(t *testing.T) {
    if testing.Short() {
        t.Skip("Skipping integration test")
    }
    
    client := NewStripeClient(
        os.Getenv("STRIPE_SECRET_KEY"),
        os.Getenv("STRIPE_WEBHOOK_SECRET"),
    )
    
    // Create payment intent for $10.00
    intent, err := client.CreatePaymentIntent(1000, "usd", map[string]string{
        "sale_id": "test-sale-123",
    })
    
    require.NoError(t, err)
    assert.Equal(t, int64(1000), intent.Amount)
    assert.Equal(t, "usd", intent.Currency)
    assert.Equal(t, "test-sale-123", intent.Metadata["sale_id"])
}
```

### Manual Webhook Testing with Stripe CLI

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login to Stripe
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:8080/webhooks/stripe

# Trigger test webhook
stripe trigger payment_intent.succeeded
```

---

## Time Estimate

**Estimated**: 2 hours (setup) + 1 hour (testing)
**Actual**: ___ hours

---

## Notes

- Use test mode keys for development (sk_test_...)
- Never commit API keys to git (use .env and .gitignore)
- Webhook signature verification is CRITICAL for security
- Stripe API version pinning ensures consistent behavior
- Consider implementing idempotency keys for payment retries
- Monitor Stripe dashboard for test payments

---

## Related Stories

- **S1.10**: Process Cash Payment (prerequisite)
- **S2.6**: Process Card Payment API (next step)
- **S2.7**: Payment Webhook Handler (uses webhook endpoint)
- **S2.8**: Card Payment UI (consumes payment intent)
