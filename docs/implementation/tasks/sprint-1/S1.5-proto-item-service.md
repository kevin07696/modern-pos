# S1.5: Define Proto Contracts - Item Service

**Sprint**: 1
**Story Points**: 5
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.4 (Common Types)

---

## User Story

As a **developer**, I want **Item Management Service proto contracts defined** so that **frontend and backend can work in parallel on menu, categories, and modifiers**.

---

## Description

Define all Protocol Buffer contracts for the Item Management Service. This includes message definitions for Items, Categories, ModifierSections, ModifierGroups, Stock, and Suppliers, plus all RPC service methods. These contracts enable contract-first development where both teams can start implementation immediately.

The service handles menu catalog management including hierarchical categories, item modifiers for customization, and inventory tracking.

---

## Acceptance Criteria

### Proto Messages Defined
- [ ] Item message with all fields
- [ ] Category message (with parent_id for hierarchy)
- [ ] ModifierSection, ModifierGroup, ModifierOption messages
- [ ] Stock and StockMovement messages
- [ ] Supplier message
- [ ] All request/response messages for RPC methods

### Service Definition
- [ ] ItemManagementService defined
- [ ] Item CRUD methods (Create, Update, Get, List, Delete)
- [ ] Category CRUD methods
- [ ] Modifier CRUD methods
- [ ] Stock management methods
- [ ] Supplier management methods

### Validation and Documentation
- [ ] All fields documented with comments
- [ ] Required vs optional fields clearly marked
- [ ] Validation rules documented
- [ ] Example requests/responses provided
- [ ] Lint rules passing
- [ ] No breaking changes from baseline

---

## Definition of Done

- [x] Proto file `item/v1/item_service.proto` created
- [x] All messages defined with proper types
- [x] All RPC methods defined
- [x] Comprehensive inline documentation
- [x] Lint validation passing
- [x] Code generation successful
- [x] Go code compiles
- [x] TypeScript code compiles
- [x] Reviewed by both developers
- [x] Code reviewed and approved

---

## Technical Details

### Proto File (`proto/item/v1/item_service.proto`)

```protobuf
syntax = "proto3";

package item.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "common/v1/money.proto";
import "common/v1/localized_string.proto";
import "common/v1/types.proto";

option go_package = "github.com/modernpos/pos/gen/proto/go/item/v1;itemv1";

// ItemManagementService manages menu items, categories, modifiers, and stock
service ItemManagementService {
  // Item operations
  rpc CreateItem(CreateItemRequest) returns (Item);
  rpc UpdateItem(UpdateItemRequest) returns (Item);
  rpc GetItem(GetItemRequest) returns (Item);
  rpc ListItems(ListItemsRequest) returns (ListItemsResponse);
  rpc DeleteItem(DeleteItemRequest) returns (google.protobuf.Empty);

  // Category operations
  rpc CreateCategory(CreateCategoryRequest) returns (Category);
  rpc UpdateCategory(UpdateCategoryRequest) returns (Category);
  rpc GetCategory(GetCategoryRequest) returns (Category);
  rpc ListCategories(ListCategoriesRequest) returns (ListCategoriesResponse);
  rpc DeleteCategory(DeleteCategoryRequest) returns (google.protobuf.Empty);

  // Modifier operations
  rpc CreateModifierSection(CreateModifierSectionRequest) returns (ModifierSection);
  rpc UpdateModifierSection(UpdateModifierSectionRequest) returns (ModifierSection);
  rpc GetModifierSection(GetModifierSectionRequest) returns (ModifierSection);
  rpc ListModifierSections(ListModifierSectionsRequest) returns (ListModifierSectionsResponse);

  rpc CreateModifierGroup(CreateModifierGroupRequest) returns (ModifierGroup);
  rpc UpdateModifierGroup(UpdateModifierGroupRequest) returns (ModifierGroup);
  rpc GetModifierGroup(GetModifierGroupRequest) returns (ModifierGroup);

  // Stock operations
  rpc UpdateStock(UpdateStockRequest) returns (Stock);
  rpc GetStock(GetStockRequest) returns (Stock);
  rpc ListStock(ListStockRequest) returns (ListStockResponse);
  rpc RecordStockMovement(RecordStockMovementRequest) returns (StockMovement);
  rpc GetStockMovements(GetStockMovementsRequest) returns (GetStockMovementsResponse);

  // Supplier operations
  rpc CreateSupplier(CreateSupplierRequest) returns (Supplier);
  rpc UpdateSupplier(UpdateSupplierRequest) returns (Supplier);
  rpc ListSuppliers(ListSuppliersRequest) returns (ListSuppliersResponse);
}

// ============================================================================
// Item Messages
// ============================================================================

// Item represents a sellable product
message Item {
  string id = 1;
  string sku = 2;  // Unique product code
  common.v1.LocalizedString name = 3;
  common.v1.LocalizedString description = 4;
  common.v1.Money price = 5;
  string category_id = 6;
  bool sellable = 7;  // Can be sold
  bool stockable = 8;  // Tracks inventory
  repeated string modifier_section_ids = 9;
  string image_url = 10;
  bool active = 11;
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
}

message CreateItemRequest {
  string sku = 1;
  common.v1.LocalizedString name = 2;
  common.v1.LocalizedString description = 3;
  common.v1.Money price = 4;
  string category_id = 5;
  bool sellable = 6;
  bool stockable = 7;
  repeated string modifier_section_ids = 8;
  string image_url = 9;
}

message UpdateItemRequest {
  string id = 1;
  optional string sku = 2;
  optional common.v1.LocalizedString name = 3;
  optional common.v1.LocalizedString description = 4;
  optional common.v1.Money price = 5;
  optional string category_id = 6;
  optional bool sellable = 7;
  optional bool stockable = 8;
  repeated string modifier_section_ids = 9;
  optional string image_url = 10;
  optional bool active = 11;
}

message GetItemRequest {
  string id = 1;
}

message ListItemsRequest {
  optional string category_id = 1;
  optional bool sellable = 2;
  optional bool active = 3;
  optional string search_query = 4;  // Search name/SKU
  common.v1.PaginationRequest pagination = 5;
}

message ListItemsResponse {
  repeated Item items = 1;
  common.v1.PaginationResponse pagination = 2;
}

message DeleteItemRequest {
  string id = 1;
}

// ============================================================================
// Category Messages (n-level hierarchy)
// ============================================================================

message Category {
  string id = 1;
  common.v1.LocalizedString name = 2;
  common.v1.LocalizedString description = 3;
  optional string parent_id = 4;  // null for root categories
  int32 display_order = 5;
  optional string icon_url = 6;
  optional string color = 7;  // Hex color code
  bool active = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

message CreateCategoryRequest {
  common.v1.LocalizedString name = 1;
  common.v1.LocalizedString description = 2;
  optional string parent_id = 3;
  int32 display_order = 4;
  optional string icon_url = 5;
  optional string color = 6;
}

message UpdateCategoryRequest {
  string id = 1;
  optional common.v1.LocalizedString name = 2;
  optional common.v1.LocalizedString description = 3;
  optional string parent_id = 4;
  optional int32 display_order = 5;
  optional string icon_url = 6;
  optional string color = 7;
  optional bool active = 8;
}

message GetCategoryRequest {
  string id = 1;
}

message ListCategoriesRequest {
  optional string parent_id = 1;  // Filter by parent (null for root)
  optional bool active = 2;
  common.v1.PaginationRequest pagination = 3;
}

message ListCategoriesResponse {
  repeated Category categories = 1;
  common.v1.PaginationResponse pagination = 2;
}

message DeleteCategoryRequest {
  string id = 1;
}

// ============================================================================
// Modifier Messages
// ============================================================================

// ModifierSection groups related modifier options (e.g., "Size", "Toppings")
message ModifierSection {
  string id = 1;
  common.v1.LocalizedString name = 2;
  common.v1.LocalizedString description = 3;
  int32 min_selection = 4;  // Minimum required selections
  int32 max_selection = 5;  // Maximum allowed selections
  bool required = 6;
  repeated ModifierGroup groups = 7;
  bool active = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

// ModifierGroup contains selectable options (e.g., "Small/Medium/Large")
message ModifierGroup {
  string id = 1;
  string section_id = 2;
  common.v1.LocalizedString name = 3;
  int32 display_order = 4;
  repeated ModifierOption options = 5;
  bool active = 6;
  google.protobuf.Timestamp created_at = 7;
}

// ModifierOption is an individual choice
message ModifierOption {
  string id = 1;
  string group_id = 2;
  common.v1.LocalizedString name = 3;
  common.v1.Money price_adjustment = 4;  // Can be negative, zero, or positive
  int32 display_order = 5;
  bool active = 6;
  google.protobuf.Timestamp created_at = 7;
}

message CreateModifierSectionRequest {
  common.v1.LocalizedString name = 1;
  common.v1.LocalizedString description = 2;
  int32 min_selection = 3;
  int32 max_selection = 4;
  bool required = 5;
}

message UpdateModifierSectionRequest {
  string id = 1;
  optional common.v1.LocalizedString name = 2;
  optional common.v1.LocalizedString description = 3;
  optional int32 min_selection = 4;
  optional int32 max_selection = 5;
  optional bool required = 6;
  optional bool active = 7;
}

message GetModifierSectionRequest {
  string id = 1;
}

message ListModifierSectionsRequest {
  optional bool active = 1;
  common.v1.PaginationRequest pagination = 2;
}

message ListModifierSectionsResponse {
  repeated ModifierSection sections = 1;
  common.v1.PaginationResponse pagination = 2;
}

message CreateModifierGroupRequest {
  string section_id = 1;
  common.v1.LocalizedString name = 2;
  int32 display_order = 3;
}

message UpdateModifierGroupRequest {
  string id = 1;
  optional common.v1.LocalizedString name = 2;
  optional int32 display_order = 3;
  optional bool active = 4;
}

message GetModifierGroupRequest {
  string id = 1;
}

// ============================================================================
// Stock Messages
// ============================================================================

message Stock {
  string id = 1;
  string item_id = 2;
  string location_id = 3;
  double quantity = 4;
  double reorder_level = 5;
  double reorder_qty = 6;
  string uom = 7;  // Unit of measure (ea, kg, lb, etc.)
  google.protobuf.Timestamp updated_at = 8;
}

message UpdateStockRequest {
  string item_id = 1;
  string location_id = 2;
  double quantity = 3;
  optional double reorder_level = 4;
  optional double reorder_qty = 5;
}

message GetStockRequest {
  string item_id = 1;
  string location_id = 2;
}

message ListStockRequest {
  optional string location_id = 1;
  optional bool low_stock_only = 2;  // quantity <= reorder_level
  common.v1.PaginationRequest pagination = 3;
}

message ListStockResponse {
  repeated Stock stocks = 1;
  common.v1.PaginationResponse pagination = 2;
}

// StockMovement tracks inventory changes (audit trail)
message StockMovement {
  string id = 1;
  string item_id = 2;
  string location_id = 3;
  StockMovementType type = 4;
  double quantity = 5;  // Can be negative for deductions
  optional string reason = 6;
  string user_id = 7;
  optional string reference = 8;  // Sale ID, PO number, etc.
  google.protobuf.Timestamp created_at = 9;
}

enum StockMovementType {
  STOCK_MOVEMENT_TYPE_UNSPECIFIED = 0;
  STOCK_MOVEMENT_TYPE_SALE = 1;          // Item sold
  STOCK_MOVEMENT_TYPE_PURCHASE = 2;       // Received from supplier
  STOCK_MOVEMENT_TYPE_ADJUSTMENT = 3;     // Manual adjustment
  STOCK_MOVEMENT_TYPE_TRANSFER = 4;       // Transfer between locations
  STOCK_MOVEMENT_TYPE_WASTE = 5;          // Spoilage or damage
  STOCK_MOVEMENT_TYPE_RETURN = 6;         // Customer return
}

message RecordStockMovementRequest {
  string item_id = 1;
  string location_id = 2;
  StockMovementType type = 3;
  double quantity = 4;
  optional string reason = 5;
  string user_id = 6;
  optional string reference = 7;
}

message GetStockMovementsRequest {
  optional string item_id = 1;
  optional string location_id = 2;
  optional StockMovementType type = 3;
  optional common.v1.TimeRange time_range = 4;
  common.v1.PaginationRequest pagination = 5;
}

message GetStockMovementsResponse {
  repeated StockMovement movements = 1;
  common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// Supplier Messages
// ============================================================================

message Supplier {
  string id = 1;
  string name = 2;
  optional string email = 3;
  optional string phone = 4;
  optional common.v1.Address address = 5;
  optional string payment_terms = 6;
  bool active = 7;
  google.protobuf.Timestamp created_at = 8;
}

message CreateSupplierRequest {
  string name = 1;
  optional string email = 2;
  optional string phone = 3;
  optional common.v1.Address address = 4;
  optional string payment_terms = 5;
}

message UpdateSupplierRequest {
  string id = 1;
  optional string name = 2;
  optional string email = 3;
  optional string phone = 4;
  optional common.v1.Address address = 5;
  optional string payment_terms = 6;
  optional bool active = 7;
}

message ListSuppliersRequest {
  optional bool active = 1;
  common.v1.PaginationRequest pagination = 2;
}

message ListSuppliersResponse {
  repeated Supplier suppliers = 1;
  common.v1.PaginationResponse pagination = 2;
}
```

---

## Implementation Steps

1. Create `proto/item/v1/` directory
2. Create `item_service.proto` file
3. Add syntax, package, and options
4. Import common types (Money, LocalizedString, etc.)
5. Define ItemManagementService with all RPC methods
6. Define Item and related request/response messages
7. Define Category messages (with parent_id for hierarchy)
8. Define ModifierSection, ModifierGroup, ModifierOption messages
9. Define Stock and StockMovement messages
10. Define StockMovementType enum
11. Define Supplier messages
12. Add comprehensive documentation comments
13. Run `make proto-lint` and fix issues
14. Run `make proto-generate` to test
15. Verify Go code compiles
16. Verify TypeScript code compiles
17. Review with team

---

## Testing

### Manual Test Cases

**Test 1: Lint validation**
```bash
make proto-lint

# Expected: No errors
```

**Test 2: Code generation**
```bash
make proto-generate

# Expected: Files generated in:
# - gen/proto/go/item/v1/
# - frontend/src/gen/item/v1/
```

**Test 3: Go compilation**
```bash
# Create test file using generated types
cd services/item-management
cat > test.go <<EOF
package main
import itemv1 "github.com/modernpos/pos/gen/proto/go/item/v1"
func main() {
    _ = &itemv1.Item{}
}
EOF
go build test.go

# Expected: Compiles without errors
```

**Test 4: TypeScript types**
```typescript
// In frontend test file
import { Item } from '@/gen/item/v1/item_service_pb';

const item: Item = {
  id: '123',
  sku: 'KUNG-PAO',
  name: { translations: { 'en-US': 'Kung Pao Chicken' } },
  // ... more fields
};

// Expected: TypeScript compiler accepts
```

---

## Time Estimate

**Estimated**: 3 hours (definition) + 1 hour (testing) + 1 hour (review)
**Actual**: ___ hours

---

## Notes

- Use LocalizedString for all user-facing text (name, description)
- Money type for all monetary values (price, price_adjustment)
- Category parent_id is optional (null for root categories)
- ModifierOption price_adjustment can be negative (discount)
- Stock quantity uses double for decimal support (e.g., 2.5 kg)
- StockMovement is immutable audit trail
- All timestamps use google.protobuf.Timestamp
- All IDs are string (UUIDs in implementation)
- **Future enhancement (S3.14)**: prep_time_minutes field for intelligent kitchen estimates

---

## Related Stories

- **S1.4**: Define Proto Contracts - Common Types (prerequisite)
- **S1.6**: Define Proto Contracts - Order Service (references Item)
- **S1.8**: Generate Code from Protos (generates this service)
- **S1.12**: Item List Component (uses these types)
