# S1.7: Define Proto Contracts - Platform Service

**Sprint**: 1
**Story Points**: 5
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.4 (Common Types)

---

## User Story

As a **developer**, I want **Platform Service proto contracts defined** so that **authentication, user management, location/tax configuration, and device management can be implemented in parallel**.

---

## Description

Define all Protocol Buffer contracts for the Platform Service. This includes message definitions for authentication (login, JWT), users, customers, locations (with tax rates), devices, settings, and audit logs. These contracts enable the foundational infrastructure that all other services depend on.

The service provides JWT-based authentication with RS256 signing, location-level tax configuration (simple single rate), and device management for POS terminals.

---

## Acceptance Criteria

### Proto Messages Defined
- [ ] Authentication messages (Login, Token Validation)
- [ ] User message with role and permissions
- [ ] Customer message
- [ ] Location message with tax_rate field
- [ ] Device message with type enum
- [ ] Session management messages
- [ ] Setting (key-value config) messages
- [ ] AuditLog messages

### Service Definition
- [ ] PlatformService defined
- [ ] Auth methods (Login, RefreshToken, Logout, ValidateToken)
- [ ] User CRUD methods
- [ ] Customer CRUD methods
- [ ] Location CRUD methods
- [ ] GetTaxRate method (critical for order service)
- [ ] Device management methods
- [ ] Settings methods
- [ ] Audit log methods

### Validation and Documentation
- [ ] All fields documented with comments
- [ ] Enums defined (UserRole, DeviceType)
- [ ] Permission structure documented
- [ ] Tax rate validation rules documented
- [ ] Lint rules passing

---

## Definition of Done

- [x] Proto file `platform/v1/platform_service.proto` created
- [x] All messages defined with proper types
- [x] All RPC methods defined
- [x] Comprehensive inline documentation
- [x] Lint validation passing
- [x] Code generation successful
- [x] Go code compiles
- [x] TypeScript code compiles
- [x] Reviewed by both developers
- [x] Code reviewed and approved

---

## Technical Details

### Proto File (`proto/platform/v1/platform_service.proto`)

```protobuf
syntax = "proto3";

package platform.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "common/v1/types.proto";
import "common/v1/money.proto";

option go_package = "github.com/modernpos/pos/gen/proto/go/platform/v1;platformv1";

// PlatformService provides authentication, user management, and foundational infrastructure
service PlatformService {
  // Authentication
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  rpc Logout(LogoutRequest) returns (google.protobuf.Empty);
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);

  // Users
  rpc CreateUser(CreateUserRequest) returns (User);
  rpc UpdateUser(UpdateUserRequest) returns (User);
  rpc GetUser(GetUserRequest) returns (User);
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc ChangePassword(ChangePasswordRequest) returns (google.protobuf.Empty);
  rpc UpdatePermissions(UpdatePermissionsRequest) returns (User);

  // Customers
  rpc CreateCustomer(CreateCustomerRequest) returns (Customer);
  rpc UpdateCustomer(UpdateCustomerRequest) returns (Customer);
  rpc GetCustomer(GetCustomerRequest) returns (Customer);
  rpc ListCustomers(ListCustomersRequest) returns (ListCustomersResponse);

  // Locations
  rpc CreateLocation(CreateLocationRequest) returns (Location);
  rpc UpdateLocation(UpdateLocationRequest) returns (Location);
  rpc GetLocation(GetLocationRequest) returns (Location);
  rpc ListLocations(ListLocationsRequest) returns (ListLocationsResponse);
  rpc GetTaxRate(GetTaxRateRequest) returns (GetTaxRateResponse);

  // Devices
  rpc RegisterDevice(RegisterDeviceRequest) returns (Device);
  rpc UpdateDevice(UpdateDeviceRequest) returns (Device);
  rpc GetDevice(GetDeviceRequest) returns (Device);
  rpc ListDevices(ListDevicesRequest) returns (ListDevicesResponse);
  rpc HeartbeatDevice(HeartbeatDeviceRequest) returns (google.protobuf.Empty);

  // Settings
  rpc GetSetting(GetSettingRequest) returns (Setting);
  rpc SetSetting(SetSettingRequest) returns (Setting);
  rpc ListSettings(ListSettingsRequest) returns (ListSettingsResponse);

  // Audit
  rpc RecordAuditLog(RecordAuditLogRequest) returns (google.protobuf.Empty);
  rpc GetAuditLogs(GetAuditLogsRequest) returns (GetAuditLogsResponse);
}

// ============================================================================
// Authentication Messages
// ============================================================================

message LoginRequest {
  string username = 1;
  string password = 2;
  optional string device_id = 3;
}

message LoginResponse {
  string access_token = 1;   // JWT, 1 hour expiry
  string refresh_token = 2;  // Opaque token, 30 days
  User user = 3;
  google.protobuf.Timestamp expires_at = 4;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message LogoutRequest {
  string token_id = 1;  // From JWT "jti" claim
}

message ValidateTokenRequest {
  string access_token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  optional User user = 2;
  optional string error_message = 3;
}

// ============================================================================
// User Messages
// ============================================================================

message User {
  string id = 1;
  string username = 2;
  string email = 3;
  string name = 4;
  UserRole role = 5;
  google.protobuf.Struct permissions = 6;  // Flexible JSON structure
  string location_id = 7;
  bool active = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

enum UserRole {
  USER_ROLE_UNSPECIFIED = 0;
  USER_ROLE_ADMIN = 1;      // Full system access
  USER_ROLE_MANAGER = 2;    // Location management, reports
  USER_ROLE_CASHIER = 3;    // Process sales, take payments
  USER_ROLE_KITCHEN = 4;    // View orders, update status
}

message CreateUserRequest {
  string username = 1;
  string email = 2;
  string name = 3;
  string password = 4;
  UserRole role = 5;
  google.protobuf.Struct permissions = 6;
  string location_id = 7;
}

message UpdateUserRequest {
  string id = 1;
  optional string email = 2;
  optional string name = 3;
  optional UserRole role = 4;
  optional google.protobuf.Struct permissions = 5;
  optional string location_id = 6;
  optional bool active = 7;
}

message GetUserRequest {
  string id = 1;
}

message ListUsersRequest {
  optional string location_id = 1;
  optional UserRole role = 2;
  optional bool active = 3;
  common.v1.PaginationRequest pagination = 4;
}

message ListUsersResponse {
  repeated User users = 1;
  common.v1.PaginationResponse pagination = 2;
}

message ChangePasswordRequest {
  string user_id = 1;
  string old_password = 2;
  string new_password = 3;
}

message UpdatePermissionsRequest {
  string user_id = 1;
  google.protobuf.Struct permissions = 2;
}

// ============================================================================
// Customer Messages
// ============================================================================

message Customer {
  string id = 1;
  string email = 2;
  string name = 3;
  optional string phone = 4;
  optional string mobile = 5;
  optional common.v1.Address address = 6;
  optional string notes = 7;
  bool active = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

message CreateCustomerRequest {
  string email = 1;
  string name = 2;
  optional string phone = 3;
  optional string mobile = 4;
  optional common.v1.Address address = 5;
  optional string notes = 6;
}

message UpdateCustomerRequest {
  string id = 1;
  optional string email = 2;
  optional string name = 3;
  optional string phone = 4;
  optional string mobile = 5;
  optional common.v1.Address address = 6;
  optional string notes = 7;
  optional bool active = 8;
}

message GetCustomerRequest {
  string id = 1;
}

message ListCustomersRequest {
  optional string search_query = 1;  // Search name/email/phone
  optional bool active = 2;
  common.v1.PaginationRequest pagination = 3;
}

message ListCustomersResponse {
  repeated Customer customers = 1;
  common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// Location Messages
// ============================================================================

// Location represents a store/restaurant location
message Location {
  string id = 1;
  string name = 2;

  // Address
  optional string address = 3;
  optional string city = 4;
  optional string state_province = 5;
  optional string postal_code = 6;
  string country_code = 7;  // ISO 3166-1 alpha-2 (US, PH, CA)

  // Internationalization
  string currency_code = 8;  // ISO 4217 (USD, PHP, CAD)
  string timezone = 9;       // IANA timezone (America/New_York, Asia/Manila)

  // Tax configuration (simple, single rate per location)
  common.v1.Percentage tax_rate = 10;  // 8.75% = 875 basis points

  // Receipt customization
  optional string receipt_footer = 11;

  bool active = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
}

message CreateLocationRequest {
  string name = 1;
  optional string address = 2;
  optional string city = 3;
  optional string state_province = 4;
  optional string postal_code = 5;
  string country_code = 6;
  string currency_code = 7;
  string timezone = 8;
  common.v1.Percentage tax_rate = 9;
  optional string receipt_footer = 10;
}

message UpdateLocationRequest {
  string id = 1;
  optional string name = 2;
  optional string address = 3;
  optional string city = 4;
  optional string state_province = 5;
  optional string postal_code = 6;
  optional string country_code = 7;
  optional string currency_code = 8;
  optional string timezone = 9;
  optional common.v1.Percentage tax_rate = 10;
  optional string receipt_footer = 11;
  optional bool active = 12;
}

message GetLocationRequest {
  string id = 1;
}

message ListLocationsRequest {
  optional string country_code = 1;
  optional bool active = 2;
  common.v1.PaginationRequest pagination = 3;
}

message ListLocationsResponse {
  repeated Location locations = 1;
  common.v1.PaginationResponse pagination = 2;
}

// GetTaxRate is critical for Order Fulfillment Service
message GetTaxRateRequest {
  string location_id = 1;
}

message GetTaxRateResponse {
  common.v1.Percentage tax_rate = 1;
  string location_name = 2;
}

// ============================================================================
// Device Messages
// ============================================================================

message Device {
  string id = 1;
  string name = 2;
  string location_id = 3;
  DeviceType type = 4;
  optional google.protobuf.Timestamp last_seen_at = 5;
  bool active = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

enum DeviceType {
  DEVICE_TYPE_UNSPECIFIED = 0;
  DEVICE_TYPE_TERMINAL = 1;          // POS terminal (cashier)
  DEVICE_TYPE_KITCHEN = 2;           // Kitchen display
  DEVICE_TYPE_ADMIN = 3;             // Admin console
  DEVICE_TYPE_CUSTOMER_DISPLAY = 4;  // Customer-facing display
}

message RegisterDeviceRequest {
  string name = 1;
  string location_id = 2;
  DeviceType type = 3;
}

message UpdateDeviceRequest {
  string id = 1;
  optional string name = 2;
  optional string location_id = 3;
  optional bool active = 4;
}

message GetDeviceRequest {
  string id = 1;
}

message ListDevicesRequest {
  optional string location_id = 1;
  optional DeviceType type = 2;
  optional bool active = 3;
  common.v1.PaginationRequest pagination = 4;
}

message ListDevicesResponse {
  repeated Device devices = 1;
  common.v1.PaginationResponse pagination = 2;
}

message HeartbeatDeviceRequest {
  string device_id = 1;
}

// ============================================================================
// Settings Messages (Key-Value Store)
// ============================================================================

message Setting {
  string key = 1;
  google.protobuf.Struct value = 2;  // Flexible JSON value
  optional string description = 3;
  google.protobuf.Timestamp updated_at = 4;
}

message GetSettingRequest {
  string key = 1;
}

message SetSettingRequest {
  string key = 1;
  google.protobuf.Struct value = 2;
  optional string description = 3;
}

message ListSettingsRequest {
  optional string key_prefix = 1;  // Filter by key prefix
  common.v1.PaginationRequest pagination = 2;
}

message ListSettingsResponse {
  repeated Setting settings = 1;
  common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// Audit Log Messages
// ============================================================================

message AuditLog {
  string id = 1;
  optional string user_id = 2;
  string action = 3;              // "user.created", "sale.voided", etc.
  string entity_type = 4;         // "user", "sale", "item", etc.
  optional string entity_id = 5;
  optional google.protobuf.Struct details = 6;
  optional string ip_address = 7;
  optional string user_agent = 8;
  google.protobuf.Timestamp created_at = 9;
}

message RecordAuditLogRequest {
  optional string user_id = 1;
  string action = 2;
  string entity_type = 3;
  optional string entity_id = 4;
  optional google.protobuf.Struct details = 5;
  optional string ip_address = 6;
  optional string user_agent = 7;
}

message GetAuditLogsRequest {
  optional string user_id = 1;
  optional string entity_type = 2;
  optional string entity_id = 3;
  optional common.v1.TimeRange time_range = 4;
  common.v1.PaginationRequest pagination = 5;
}

message GetAuditLogsResponse {
  repeated AuditLog logs = 1;
  common.v1.PaginationResponse pagination = 2;
}
```

---

## Implementation Steps

1. Create `proto/platform/v1/` directory
2. Create `platform_service.proto` file
3. Add syntax, package, and options
4. Import common types and google protobuf types
5. Define PlatformService with all RPC methods
6. Define authentication messages (Login, Token, etc.)
7. Define User message and UserRole enum
8. Define Customer message
9. Define Location message with tax_rate (critical!)
10. Define GetTaxRate request/response (used by Order Service)
11. Define Device message and DeviceType enum
12. Define Setting message (key-value config)
13. Define AuditLog messages
14. Add comprehensive documentation comments
15. Run `make proto-lint` and fix issues
16. Run `make proto-generate` to test
17. Verify Go code compiles
18. Verify TypeScript code compiles
19. Review with team

---

## Testing

### Manual Test Cases

**Test 1: Lint validation**
```bash
make proto-lint

# Expected: No errors
```

**Test 2: Code generation**
```bash
make proto-generate

# Expected: Files generated in:
# - gen/proto/go/platform/v1/
# - frontend/src/gen/platform/v1/
```

**Test 3: Go compilation**
```bash
cd services/platform
cat > test.go <<EOF
package main
import platformv1 "github.com/modernpos/pos/gen/proto/go/platform/v1"
func main() {
    _ = &platformv1.User{Role: platformv1.UserRole_USER_ROLE_ADMIN}
    _ = &platformv1.Location{}
}
EOF
go build test.go

# Expected: Compiles without errors
```

**Test 4: Tax rate usage**
```go
// Test tax rate in Order Service
taxResp, _ := platformClient.GetTaxRate(ctx, &platformv1.GetTaxRateRequest{
    LocationId: "loc-123",
})
// taxResp.TaxRate.BasisPoints = 875 (8.75%)
```

---

## Time Estimate

**Estimated**: 3 hours (definition) + 1 hour (testing) + 1 hour (review)
**Actual**: ___ hours

---

## Notes

- Location.tax_rate is CRITICAL for Order Service
- Tax rate uses common.v1.Percentage (basis points: 8.75% = 875)
- Order Service calls GetTaxRate and snapshots value in sale_items
- JWT authentication uses RS256 (asymmetric signing)
- Only Platform Service has private key, others have public key
- Session tracking enables token revocation
- Permissions stored as JSONB (google.protobuf.Struct in proto)
- UserRole enum for basic RBAC
- DeviceType enum for different POS terminal types
- Audit logs use flexible structure for details
- Settings provide key-value config store for system-wide settings

---

## Related Stories

- **S1.4**: Define Proto Contracts - Common Types (prerequisite)
- **S1.6**: Define Proto Contracts - Order Service (calls GetTaxRate)
- **S1.8**: Generate Code from Protos (generates this service)
- **S1.9**: Create Sale with Tax (uses GetTaxRate endpoint)
