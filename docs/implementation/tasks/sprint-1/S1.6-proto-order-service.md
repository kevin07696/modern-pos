# S1.6: Define Proto Contracts - Order Service

**Sprint**: 1
**Story Points**: 5
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.4 (Common Types), S1.5 (Item Service)

---

## User Story

As a **developer**, I want **Order Fulfillment Service proto contracts defined** so that **frontend and backend can implement sales transactions, payments, and order management in parallel**.

---

## Description

Define all Protocol Buffer contracts for the Order Fulfillment Service. This includes message definitions for Sales, SaleItems, Payments, Voids/Refunds, and ParkedOrders, plus all RPC service methods. These contracts enable the complete sales transaction lifecycle from order creation through payment processing to completion.

The service handles both online and offline transactions with automatic synchronization using idempotency patterns.

---

## Acceptance Criteria

### Proto Messages Defined
- [ ] Sale message with financial totals
- [ ] SaleItem message with snapshot pattern (tax rate preserved)
- [ ] Payment message with method and status
- [ ] Void/Refund messages
- [ ] ParkedOrder message
- [ ] All request/response messages for RPC methods

### Service Definition
- [ ] OrderFulfillmentService defined
- [ ] Sale CRUD methods
- [ ] Payment processing methods (cash and card)
- [ ] Split payment support
- [ ] Void/Refund methods
- [ ] Parked order methods
- [ ] Offline sync method
- [ ] Reporting methods

### Validation and Documentation
- [ ] All fields documented with comments
- [ ] Enums defined (SaleStatus, PaymentMethod, OrderType)
- [ ] Validation rules documented
- [ ] Example requests/responses provided
- [ ] Lint rules passing

---

## Definition of Done

- [x] Proto file `order/v1/order_service.proto` created
- [x] All messages defined with proper types
- [x] All RPC methods defined
- [x] Comprehensive inline documentation
- [x] Lint validation passing
- [x] Code generation successful
- [x] Go code compiles
- [x] TypeScript code compiles
- [x] Reviewed by both developers
- [x] Code reviewed and approved

---

## Technical Details

### Proto File (`proto/order/v1/order_service.proto`)

```protobuf
syntax = "proto3";

package order.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "common/v1/money.proto";
import "common/v1/localized_string.proto";
import "common/v1/types.proto";

option go_package = "github.com/modernpos/pos/gen/proto/go/order/v1;orderv1";

// OrderFulfillmentService manages sales, payments, and order lifecycle
service OrderFulfillmentService {
  // Sale operations
  rpc CreateSale(CreateSaleRequest) returns (Sale);
  rpc GetSale(GetSaleRequest) returns (Sale);
  rpc ListSales(ListSalesRequest) returns (ListSalesResponse);
  rpc UpdateSale(UpdateSaleRequest) returns (Sale);

  // Payment operations
  rpc ProcessPayment(ProcessPaymentRequest) returns (ProcessPaymentResponse);
  rpc ProcessSplitPayment(ProcessSplitPaymentRequest) returns (ProcessSplitPaymentResponse);

  // Void/Refund operations
  rpc VoidSale(VoidSaleRequest) returns (VoidSaleResponse);
  rpc RefundSale(RefundSaleRequest) returns (RefundSaleResponse);

  // Parked orders
  rpc ParkOrder(ParkOrderRequest) returns (ParkedOrder);
  rpc GetParkedOrder(GetParkedOrderRequest) returns (ParkedOrder);
  rpc ResumeParkedOrder(ResumeParkedOrderRequest) returns (Sale);
  rpc ListParkedOrders(ListParkedOrdersRequest) returns (ListParkedOrdersResponse);

  // Offline sync
  rpc SyncOfflineSales(SyncOfflineSalesRequest) returns (SyncOfflineSalesResponse);

  // Reporting
  rpc GetSaleHistory(GetSaleHistoryRequest) returns (GetSaleHistoryResponse);
  rpc GetSalesSummary(GetSalesSummaryRequest) returns (SalesSummary);
}

// ============================================================================
// Sale Messages
// ============================================================================

// Sale represents a complete transaction
message Sale {
  string id = 1;  // UUID - also serves as idempotency key for offline sync
  int32 display_number = 2;  // Customer-facing order number: resets daily per location (1-999)
  SaleType type = 3;
  SaleStatus status = 4;

  // Financial totals
  common.v1.Money subtotal = 5;
  common.v1.Money discount = 6;
  common.v1.Money tax_amount = 7;
  common.v1.Money total = 8;

  // Items
  repeated SaleItem items = 9;

  // Payments
  repeated Payment payments = 10;

  // Context
  optional string customer_id = 11;
  string user_id = 12;
  string device_id = 13;
  string location_id = 14;

  // Metadata
  optional string notes = 15;
  optional int32 table_number = 16;
  OrderType order_type = 17;

  // Audit
  optional google.protobuf.Timestamp processed_at = 18;
  google.protobuf.Timestamp created_at = 19;
  google.protobuf.Timestamp updated_at = 20;
}

// SaleItem represents a line item with snapshot pattern
message SaleItem {
  string id = 1;
  string sale_id = 2;
  string item_id = 3;  // Reference to original item

  // Snapshot (preserves historical data)
  string name = 4;
  optional string description = 5;

  // Quantity & Pricing
  double quantity = 6;
  common.v1.Money unit_price = 7;

  // Tax snapshot (preserves rate at time of sale)
  common.v1.Percentage tax_rate = 8;
  common.v1.Money tax_amount = 9;

  common.v1.Money total = 10;

  // Modifiers (as selected by user)
  repeated AppliedModifier modifiers = 11;

  // Metadata
  optional string notes = 12;
  google.protobuf.Timestamp created_at = 13;
}

// AppliedModifier represents a modifier selection on an item
message AppliedModifier {
  string modifier_id = 1;
  string name = 2;
  common.v1.Money price_adjustment = 3;
}

enum SaleType {
  SALE_TYPE_UNSPECIFIED = 0;
  SALE_TYPE_SALE = 1;       // Standard sale
  SALE_TYPE_ORDER = 2;      // Order for later fulfillment
  SALE_TYPE_INVOICE = 3;    // Invoice for payment later
}

enum SaleStatus {
  SALE_STATUS_UNSPECIFIED = 0;
  SALE_STATUS_PENDING = 1;         // Created, awaiting payment
  SALE_STATUS_COMPLETED = 2;       // Payment completed
  SALE_STATUS_VOIDED = 3;          // Cancelled/voided
  SALE_STATUS_REFUNDED = 4;        // Fully refunded
  SALE_STATUS_PARTIALLY_REFUNDED = 5;  // Partial refund
}

enum OrderType {
  ORDER_TYPE_UNSPECIFIED = 0;
  ORDER_TYPE_COUNTER = 1;    // Quick service counter
  ORDER_TYPE_TAKEOUT = 2;    // Takeout order
  ORDER_TYPE_DELIVERY = 3;   // Delivery order
  ORDER_TYPE_DINE_IN = 4;    // Dine-in (future)
}

message CreateSaleRequest {
  SaleType type = 1;
  repeated CreateSaleItemRequest items = 2;
  string user_id = 3;
  string device_id = 4;
  string location_id = 5;
  optional string customer_id = 6;
  optional string notes = 7;
  optional int32 table_number = 8;
  OrderType order_type = 9;

  // For offline sync: pre-generated UUID for idempotency
  optional string id = 10;

  // For offline sync: backdated timestamp
  optional google.protobuf.Timestamp created_at = 11;
}

message CreateSaleItemRequest {
  string item_id = 1;
  double quantity = 2;
  repeated string modifier_ids = 3;
  optional string notes = 4;
}

message GetSaleRequest {
  string id = 1;
}

message ListSalesRequest {
  optional string location_id = 1;
  optional string user_id = 2;
  optional SaleStatus status = 3;
  optional common.v1.TimeRange time_range = 4;
  common.v1.PaginationRequest pagination = 5;
}

message ListSalesResponse {
  repeated Sale sales = 1;
  common.v1.PaginationResponse pagination = 2;
}

message UpdateSaleRequest {
  string id = 1;
  optional string notes = 2;
  optional SaleStatus status = 3;
}

// ============================================================================
// Payment Messages
// ============================================================================

message Payment {
  string id = 1;
  string sale_id = 2;
  string transaction_group_id = 3;  // Groups split payments

  PaymentMethod method = 4;
  common.v1.Money amount = 5;
  PaymentStatus status = 6;

  // Card-specific fields
  optional string card_type = 7;    // Visa, Mastercard, etc.
  optional string last4 = 8;
  optional string approval_code = 9;

  // Cash-specific fields
  optional common.v1.Money amount_tendered = 10;
  optional common.v1.Money change_given = 11;

  // Audit
  google.protobuf.Timestamp processed_at = 12;
  google.protobuf.Timestamp created_at = 13;
}

enum PaymentMethod {
  PAYMENT_METHOD_UNSPECIFIED = 0;
  PAYMENT_METHOD_CASH = 1;
  PAYMENT_METHOD_CARD = 2;
  PAYMENT_METHOD_DIGITAL = 3;       // Apple Pay, Google Pay, etc.
  PAYMENT_METHOD_CHECK = 4;
  PAYMENT_METHOD_STORE_CREDIT = 5;
}

enum PaymentStatus {
  PAYMENT_STATUS_UNSPECIFIED = 0;
  PAYMENT_STATUS_PENDING = 1;
  PAYMENT_STATUS_COMPLETED = 2;
  PAYMENT_STATUS_FAILED = 3;
  PAYMENT_STATUS_REFUNDED = 4;
}

message ProcessPaymentRequest {
  string sale_id = 1;
  PaymentMethod method = 2;

  // For cash
  optional common.v1.Money amount_tendered = 3;

  // For card (processed via Payment Service)
  optional string payment_token = 4;
}

message ProcessPaymentResponse {
  Payment payment = 1;
  Sale sale = 2;  // Updated sale with completed status

  // For cash
  optional common.v1.Money change = 3;
}

message ProcessSplitPaymentRequest {
  string sale_id = 1;
  repeated SplitPaymentPart parts = 2;
}

message SplitPaymentPart {
  PaymentMethod method = 1;
  common.v1.Money amount = 2;

  // Method-specific fields
  optional common.v1.Money amount_tendered = 3;  // Cash
  optional string payment_token = 4;              // Card
}

message ProcessSplitPaymentResponse {
  repeated Payment payments = 1;
  Sale sale = 2;
  common.v1.Money total_change = 3;  // Total change from all cash parts
}

// ============================================================================
// Void/Refund Messages
// ============================================================================

message VoidSaleRequest {
  string sale_id = 1;
  string reason = 2;
  string user_id = 3;
  string device_id = 4;
}

message VoidSaleResponse {
  Sale sale = 1;  // Sale with voided status
  Void void = 2;  // Void record
}

message RefundSaleRequest {
  string sale_id = 1;
  RefundType type = 2;
  string reason = 3;
  string user_id = 4;
  string device_id = 5;

  // For partial refund
  repeated RefundItem items = 6;
}

message RefundItem {
  string sale_item_id = 1;
  double quantity = 2;
}

enum RefundType {
  REFUND_TYPE_UNSPECIFIED = 0;
  REFUND_TYPE_FULL = 1;
  REFUND_TYPE_PARTIAL = 2;
}

message RefundSaleResponse {
  Sale sale = 1;  // Sale with refunded status
  Void void = 2;  // Refund record
  repeated Payment refund_payments = 3;  // Refund transactions
}

message Void {
  string id = 1;
  string sale_id = 2;
  VoidType type = 3;
  string reason = 4;
  common.v1.Money amount = 5;

  // For partial refunds
  repeated VoidItem items = 6;

  // Context
  string user_id = 7;
  string device_id = 8;
  optional string refund_txn_id = 9;

  // Audit
  google.protobuf.Timestamp created_at = 10;
}

message VoidItem {
  string sale_item_id = 1;
  string item_name = 2;
  double quantity = 3;
  common.v1.Money amount = 4;
}

enum VoidType {
  VOID_TYPE_UNSPECIFIED = 0;
  VOID_TYPE_VOID = 1;    // Full void before completion
  VOID_TYPE_REFUND = 2;  // Refund after completion
}

// ============================================================================
// Parked Order Messages
// ============================================================================

message ParkedOrder {
  string id = 1;
  string order_ref = 2;  // User-friendly reference

  // Sale snapshot
  repeated ParkedItem items = 3;
  common.v1.Money subtotal = 4;
  common.v1.Money tax_amount = 5;
  common.v1.Money total = 6;

  // Context
  string user_id = 7;
  string device_id = 8;
  string location_id = 9;
  optional int32 table_number = 10;
  optional string notes = 11;

  // Status
  bool resumed = 12;
  optional google.protobuf.Timestamp resumed_at = 13;
  optional string resumed_by_id = 14;

  // Audit
  google.protobuf.Timestamp created_at = 15;
}

message ParkedItem {
  string item_id = 1;
  string name = 2;
  double quantity = 3;
  common.v1.Money unit_price = 4;
  repeated AppliedModifier modifiers = 5;
  optional string notes = 6;
}

message ParkOrderRequest {
  string order_ref = 1;
  repeated CreateSaleItemRequest items = 2;
  string user_id = 3;
  string device_id = 4;
  string location_id = 5;
  optional int32 table_number = 6;
  optional string notes = 7;
}

message GetParkedOrderRequest {
  string id = 1;
}

message ResumeParkedOrderRequest {
  string id = 1;
  string user_id = 2;
  string device_id = 3;
}

message ListParkedOrdersRequest {
  optional string location_id = 1;
  optional bool resumed = 2;
  common.v1.PaginationRequest pagination = 3;
}

message ListParkedOrdersResponse {
  repeated ParkedOrder orders = 1;
  common.v1.PaginationResponse pagination = 2;
}

// ============================================================================
// Offline Sync Messages
// ============================================================================

message SyncOfflineSalesRequest {
  repeated Sale offline_sales = 1;
  string device_id = 2;
}

message SyncOfflineSalesResponse {
  repeated SyncResult results = 1;
  int32 created = 2;
  int32 skipped = 3;
  int32 errors = 4;
}

message SyncResult {
  string sale_id = 1;  // UUID of the sale
  SyncStatus status = 2;
  optional string error_message = 3;
  optional Sale sale = 4;  // Created or existing sale
}

enum SyncStatus {
  SYNC_STATUS_UNSPECIFIED = 0;
  SYNC_STATUS_CREATED = 1;   // New sale created
  SYNC_STATUS_SKIPPED = 2;   // Already exists (idempotent)
  SYNC_STATUS_ERROR = 3;     // Validation or processing error
}

// ============================================================================
// Reporting Messages
// ============================================================================

message GetSaleHistoryRequest {
  optional string location_id = 1;
  optional string user_id = 2;
  optional common.v1.TimeRange time_range = 3;
  common.v1.PaginationRequest pagination = 4;
}

message GetSaleHistoryResponse {
  repeated Sale sales = 1;
  common.v1.PaginationResponse pagination = 2;
}

message GetSalesSummaryRequest {
  string location_id = 1;
  common.v1.TimeRange time_range = 2;
}

message SalesSummary {
  common.v1.Money total_revenue = 1;
  int32 total_transactions = 2;
  common.v1.Money average_order_value = 3;

  // Payment method breakdown
  PaymentMethodSummary cash_sales = 4;
  PaymentMethodSummary card_sales = 5;
  PaymentMethodSummary digital_sales = 6;

  // Order type breakdown
  int32 counter_orders = 7;
  int32 takeout_orders = 8;
  int32 delivery_orders = 9;

  // Top items
  repeated ItemSummary top_items = 10;
}

message PaymentMethodSummary {
  common.v1.Money total_amount = 1;
  int32 transaction_count = 2;
  common.v1.Percentage percentage_of_total = 3;
}

message ItemSummary {
  string item_id = 1;
  string item_name = 2;
  int32 quantity_sold = 3;
  common.v1.Money revenue = 4;
}
```

---

## Implementation Steps

1. Create `proto/order/v1/` directory
2. Create `order_service.proto` file
3. Add syntax, package, and options
4. Import common types and item types
5. Define OrderFulfillmentService with all RPC methods
6. Define Sale and SaleItem messages with snapshot pattern
7. Define SaleType, SaleStatus, OrderType enums
8. Define Payment messages with PaymentMethod and PaymentStatus enums
9. Define Void/Refund messages
10. Define ParkedOrder messages
11. Define offline sync messages with SyncStatus enum
12. Define reporting messages
13. Add comprehensive documentation comments
14. Run `make proto-lint` and fix issues
15. Run `make proto-generate` to test
16. Verify Go code compiles
17. Verify TypeScript code compiles
18. Review with team

---

## Testing

### Manual Test Cases

**Test 1: Lint validation**
```bash
make proto-lint

# Expected: No errors
```

**Test 2: Code generation**
```bash
make proto-generate

# Expected: Files generated in:
# - gen/proto/go/order/v1/
# - frontend/src/gen/order/v1/
```

**Test 3: Go compilation**
```bash
cd services/order-fulfillment
cat > test.go <<EOF
package main
import orderv1 "github.com/modernpos/pos/gen/proto/go/order/v1"
func main() {
    _ = &orderv1.Sale{}
}
EOF
go build test.go

# Expected: Compiles without errors
```

**Test 4: Message validation**
```go
// Test snapshot pattern and display number
sale := &orderv1.Sale{
    Id: "550e8400-e29b-41d4-a91d-146655440000",
    DisplayNumber: 123,  // Customer sees "Order #123"
    Items: []*orderv1.SaleItem{
        {
            Name: "Kung Pao Chicken",
            UnitPrice: &commonv1.Money{Amount: 1050, CurrencyCode: "USD"},
            TaxRate: &commonv1.Percentage{BasisPoints: 875}, // 8.75%
        },
    },
}
// Verify: Tax rate preserved in sale item
// Verify: Display number is customer-friendly
```

---

## Time Estimate

**Estimated**: 3 hours (definition) + 1 hour (testing) + 1 hour (review)
**Actual**: ___ hours

---

## Notes

- SaleItem uses **snapshot pattern**: stores tax_rate at time of sale
- This preserves historical accuracy if tax rates change later
- **Dual identifier system**:
  - `id` (UUID): Internal database primary key + offline sync idempotency key
  - `display_number` (int32): Customer-facing order number (resets daily per location: #1, #2, #3...)
- Offline devices pre-generate UUIDs locally for idempotent sync
- Display number provides customer-friendly receipts without leaking implementation details
- Split payments share same transaction_group_id
- Payment processing coordinates with external Payment Service
- Void = before completion, Refund = after completion
- ParkedOrder saves incomplete orders for later resume
- All financial amounts use common.v1.Money
- Tax rate uses common.v1.Percentage (basis points)
- **Future enhancement (Backlog)**: SaleItem will snapshot prep_time_minutes from Item for intelligent kitchen estimates

---

## Related Stories

- **S1.4**: Define Proto Contracts - Common Types (prerequisite)
- **S1.5**: Define Proto Contracts - Item Service (references items)
- **S1.7**: Define Proto Contracts - Platform Service (tax rates)
- **S1.8**: Generate Code from Protos (generates this service)
- **S1.9**: Create Sale with Tax (implements CreateSale)
- **S1.10**: Process Cash Payment (implements ProcessPayment)
