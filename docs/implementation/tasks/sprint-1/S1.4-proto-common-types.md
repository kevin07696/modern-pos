# S1.4: Define Proto Contracts - Common Types

**Sprint**: 1
**Story Points**: 3
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.3 (Setup Buf CLI)

---

## User Story

As a **developer**, I want **common proto types defined** so that **all services use consistent data structures for money, localized strings, and pagination**.

---

## Description

Define shared Protocol Buffer message types that will be used across all microservices. These common types ensure consistency in how we represent money (with currency), multi-language support (localized strings), dates/times (with timezone awareness), and pagination.

These types form the foundation of our API contracts and prevent duplication across services.

---

## Acceptance Criteria

### Common Types Defined
- [ ] Money type with amount and currency
- [ ] LocalizedString type for i18n support
- [ ] Percentage type for rates (tax, discount)
- [ ] Pagination request/response types
- [ ] Address type for locations
- [ ] Timestamp usage (google.protobuf.Timestamp)

### Proto Files Created
- [ ] `proto/common/v1/money.proto`
- [ ] `proto/common/v1/localized_string.proto`
- [ ] `proto/common/v1/types.proto` (other common types)
- [ ] All files lint successfully
- [ ] All files documented with comments

### Type Validation
- [ ] Money amount uses appropriate precision
- [ ] Currency codes follow ISO 4217
- [ ] Localized strings support multiple languages
- [ ] Pagination includes page size limits

---

## Definition of Done

- [x] All common proto files created
- [x] Lint rules passing
- [x] Inline documentation complete
- [x] Example usage documented
- [x] Types reviewed by both developers
- [x] No breaking changes introduced
- [x] Generated code compiles in Go
- [x] Generated code compiles in TypeScript
- [x] Code reviewed and approved

---

## Technical Details

### Money Type (`proto/common/v1/money.proto`)

```protobuf
syntax = "proto3";

package common.v1;

option go_package = "github.com/modernpos/pos/gen/proto/go/common/v1;commonv1";

// Money represents a monetary amount with currency.
// Use int64 for amount to avoid floating-point precision issues.
// Amount is in the smallest currency unit (cents, pence, etc.)
// Example: $10.50 USD = { amount: 1050, currency_code: "USD" }
message Money {
  // Amount in smallest currency unit (cents)
  int64 amount = 1;

  // ISO 4217 currency code (USD, EUR, PHP, etc.)
  string currency_code = 2;
}

// MoneyRange represents a min/max price range
message MoneyRange {
  Money min = 1;
  Money max = 2;
}
```

### Localized String Type (`proto/common/v1/localized_string.proto`)

```protobuf
syntax = "proto3";

package common.v1;

option go_package = "github.com/modernpos/pos/gen/proto/go/common/v1;commonv1";

// LocalizedString represents text in multiple languages
// Key is BCP 47 language tag (en-US, zh-CN, tl-PH, etc.)
// Example: { "en-US": "Coffee", "zh-CN": "咖啡", "tl-PH": "Kape" }
message LocalizedString {
  map<string, string> translations = 1;
}

// Helper to get text in user's preferred language with fallback
// Usage in domain layer, not proto definition
```

### Common Types (`proto/common/v1/types.proto`)

```protobuf
syntax = "proto3";

package common.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/modernpos/pos/gen/proto/go/common/v1;commonv1";

// Percentage represents a rate (tax, discount, etc.)
// Use basis points for precision: 8.75% = 875
// Range: 0-10000 (0% to 100%)
message Percentage {
  // Rate in basis points (8.75% = 875)
  int32 basis_points = 1;
}

// Address represents a physical location
message Address {
  string line1 = 1;
  string line2 = 2;
  string city = 3;
  string state_province = 4;
  string postal_code = 5;
  // ISO 3166-1 alpha-2 country code (US, PH, CA, etc.)
  string country_code = 6;
}

// PaginationRequest for list endpoints
message PaginationRequest {
  // Page number (1-indexed)
  int32 page = 1;

  // Items per page (max 100)
  int32 page_size = 2;

  // Optional: Sort field
  string sort_by = 3;

  // Optional: Sort direction (asc, desc)
  string sort_order = 4;
}

// PaginationResponse metadata
message PaginationResponse {
  int32 current_page = 1;
  int32 page_size = 2;
  int64 total_items = 3;
  int32 total_pages = 4;
  bool has_next = 5;
  bool has_previous = 6;
}

// TimeRange for filtering by date/time
message TimeRange {
  google.protobuf.Timestamp start = 1;
  google.protobuf.Timestamp end = 2;
}

// Metadata for audit trails
message AuditMetadata {
  google.protobuf.Timestamp created_at = 1;
  google.protobuf.Timestamp updated_at = 2;
  string created_by = 3;  // User ID
  string updated_by = 4;  // User ID
}
```

### Example Usage in Service Protos

```protobuf
import "common/v1/money.proto";
import "common/v1/localized_string.proto";
import "common/v1/types.proto";

message Item {
  string id = 1;
  common.v1.LocalizedString name = 2;
  common.v1.Money price = 3;
  common.v1.AuditMetadata metadata = 4;
}
```

---

## Implementation Steps

1. Create `proto/common/v1/` directory structure
2. Create `money.proto` with Money and MoneyRange messages
3. Create `localized_string.proto` with LocalizedString message
4. Create `types.proto` with Percentage, Address, Pagination, etc.
5. Add comprehensive inline documentation
6. Run `make proto-lint` to verify style
7. Fix any lint errors
8. Run `make proto-generate` to test code generation
9. Verify Go code compiles
10. Verify TypeScript code compiles
11. Document usage patterns for other developers
12. Review with team

---

## Testing

### Manual Test Cases

**Test 1: Lint validation**
```bash
cd proto
buf lint

# Expected: No errors for common types
```

**Test 2: Code generation**
```bash
make proto-generate

# Expected: Go files in gen/proto/go/common/v1/
# Expected: TypeScript files in frontend/src/gen/common/v1/
```

**Test 3: Go compilation**
```bash
cd services/platform
go build ./...

# Expected: No errors (once used in a service)
```

**Test 4: TypeScript compilation**
```bash
cd frontend
npm run type-check

# Expected: No errors (once used in frontend)
```

**Test 5: Money precision**
```go
// Test in Go
price := &commonv1.Money{
    Amount:       1050,  // $10.50
    CurrencyCode: "USD",
}
// Verify: amount/100 = 10.50
```

---

## Design Decisions

### Why int64 for Money Amount?

**Decision**: Use int64 for smallest currency unit (cents)

**Rationale**:
- Avoids floating-point precision errors
- Standard practice in financial systems
- Example: $10.50 stored as 1050 cents
- Max value: 92,233,720,368,547,758.07 (sufficient for any transaction)

**Alternative Rejected**: float64 or Decimal type
- Floating-point has precision issues
- Decimal adds complexity and library dependencies

### Why Basis Points for Percentage?

**Decision**: Use int32 basis points (8.75% = 875)

**Rationale**:
- Avoids floating-point precision
- Standard in financial industry
- Range 0-10000 covers 0% to 100%
- Easy conversion: basis_points / 100.0 = percentage

### Why Map for LocalizedString?

**Decision**: Use map<string, string> for translations

**Rationale**:
- Flexible language support
- BCP 47 language tags (en-US, zh-CN, tl-PH)
- Easy to add new languages
- Efficient proto encoding

**Alternative Rejected**: Repeated field of Translation messages
- More verbose
- Less efficient encoding

---

## Time Estimate

**Estimated**: 2 hours (definition) + 1 hour (testing/docs)
**Actual**: ___ hours

---

## Notes

- These types are used by ALL services - review carefully
- Breaking changes to common types affect entire system
- Consider backwards compatibility for future changes
- Money amount is ALWAYS in smallest currency unit
- Percentage is ALWAYS in basis points
- Use google.protobuf.Timestamp for all dates/times (not int64)
- All strings use UTF-8 encoding (proto3 default)

---

## Related Stories

- **S1.3**: Setup Buf CLI (prerequisite)
- **S1.5**: Define Proto Contracts - Item Service (uses these types)
- **S1.6**: Define Proto Contracts - Order Service (uses these types)
- **S1.7**: Define Proto Contracts - Platform Service (uses these types)
- **S1.8**: Generate Code from Protos (generates these types)
