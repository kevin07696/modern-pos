# S1.15: Cash Payment UI

**Sprint**: 1
**Story Points**: 5
**Assignee**: Developer B
**Priority**: P0 - Critical
**Dependencies**: S1.12 (Item List Component), S1.10 (Process Cash Payment)

---

## User Story

As a **cashier**, I want a **cash payment interface** so that **I can quickly enter the amount tendered and see the change to give to customers**.

---

## Description

Build the cash payment UI component that displays the order total, accepts amount tendered input, calculates change in real-time, and completes the sale by calling the Process Payment API. The interface should be fast, keyboard-friendly, and display clear feedback for successful transactions.

---

## Acceptance Criteria

### Display Functionality
- [ ] Shows order total prominently
- [ ] Shows subtotal, tax, and total breakdown
- [ ] Amount tendered input field (numeric keypad friendly)
- [ ] Real-time change calculation display
- [ ] Visual feedback for insufficient/sufficient payment
- [ ] Loading state during payment processing
- [ ] Success confirmation screen

### Interaction
- [ ] Auto-focus on amount tendered input
- [ ] Keyboard shortcuts (Enter to submit)
- [ ] Quick amount buttons ($20, $50, $100, Exact)
- [ ] Clear/reset button
- [ ] Disable submit if amount < total
- [ ] Show error messages clearly

### Business Logic
- [ ] Validate amount tendered >= total
- [ ] Calculate change accurately
- [ ] Call ProcessPayment API
- [ ] Handle API errors gracefully
- [ ] Clear order after successful payment
- [ ] Navigate to receipt/new order screen

---

## Definition of Done

- [x] CashPayment component implemented
- [x] ConnectRPC integration for ProcessPayment
- [x] Real-time change calculation
- [x] Quick amount buttons
- [x] Error handling
- [x] Success screen
- [x] Unit tests
- [x] Manual testing completed
- [x] Responsive design
- [x] Code reviewed and approved

---

## Technical Details

### Component Implementation

```typescript
// components/CashPayment.tsx

import { useState } from 'react';
import { useMutation } from '@tanstack/react-query';
import { orderClient } from '@/lib/api';
import { Sale } from '@/gen/order/v1/order_service_pb';

interface CashPaymentProps {
  sale: Sale;
  onComplete: (sale: Sale) => void;
}

export function CashPayment({ sale, onComplete }: CashPaymentProps) {
  const [amountTendered, setAmountTendered] = useState('');

  const totalCents = Number(sale.total?.amount || 0n);
  const totalDollars = totalCents / 100;

  const tenderedCents = Math.round(parseFloat(amountTendered || '0') * 100);
  const changeCents = tenderedCents - totalCents;
  const changeDollars = changeCents / 100;

  const isValid = tenderedCents >= totalCents;

  const processPayment = useMutation({
    mutationFn: async () => {
      const response = await orderClient.processPayment({
        saleId: sale.id,
        method: PaymentMethod.PAYMENT_METHOD_CASH,
        amountTendered: {
          amount: BigInt(tenderedCents),
          currencyCode: sale.total?.currencyCode || 'USD',
        },
      });
      return response;
    },
    onSuccess: (response) => {
      onComplete(response.sale);
    },
    onError: (error) => {
      console.error('Payment failed:', error);
      alert('Payment failed: ' + error.message);
    },
  });

  const handleQuickAmount = (amount: number) => {
    setAmountTendered(amount.toFixed(2));
  };

  const handleExact = () => {
    setAmountTendered(totalDollars.toFixed(2));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (isValid && !processPayment.isPending) {
      processPayment.mutate();
    }
  };

  return (
    <div className="cash-payment">
      <h2>Cash Payment</h2>

      {/* Order Summary */}
      <div className="order-summary">
        <div className="line-item">
          <span>Subtotal:</span>
          <span>${formatMoney(sale.subtotal)}</span>
        </div>
        <div className="line-item">
          <span>Tax:</span>
          <span>${formatMoney(sale.taxAmount)}</span>
        </div>
        <div className="total">
          <span>Total:</span>
          <span>${formatMoney(sale.total)}</span>
        </div>
      </div>

      <form onSubmit={handleSubmit}>
        {/* Amount Tendered Input */}
        <div className="input-group">
          <label>Amount Tendered</label>
          <input
            type="number"
            step="0.01"
            min="0"
            value={amountTendered}
            onChange={(e) => setAmountTendered(e.target.value)}
            placeholder="0.00"
            autoFocus
            className="amount-input"
          />
        </div>

        {/* Quick Amount Buttons */}
        <div className="quick-amounts">
          <button type="button" onClick={() => handleQuickAmount(20)}>
            $20
          </button>
          <button type="button" onClick={() => handleQuickAmount(50)}>
            $50
          </button>
          <button type="button" onClick={() => handleQuickAmount(100)}>
            $100
          </button>
          <button type="button" onClick={handleExact}>
            Exact
          </button>
        </div>

        {/* Change Display */}
        {amountTendered && (
          <div className={`change-display ${isValid ? 'valid' : 'invalid'}`}>
            <span>Change:</span>
            <span className="change-amount">
              {isValid ? `$${changeDollars.toFixed(2)}` : 'Insufficient'}
            </span>
          </div>
        )}

        {/* Submit Button */}
        <button
          type="submit"
          disabled={!isValid || processPayment.isPending}
          className="btn-submit"
        >
          {processPayment.isPending ? 'Processing...' : 'Complete Payment'}
        </button>

        <button
          type="button"
          onClick={() => setAmountTendered('')}
          className="btn-clear"
        >
          Clear
        </button>
      </form>

      {/* Success Screen */}
      {processPayment.isSuccess && (
        <div className="success-modal">
          <h3>âœ“ Payment Successful</h3>
          <p>Change: ${changeDollars.toFixed(2)}</p>
          <button onClick={() => onComplete(processPayment.data.sale)}>
            New Order
          </button>
        </div>
      )}
    </div>
  );
}

function formatMoney(money?: { amount: bigint; currencyCode: string }): string {
  if (!money) return '0.00';
  return (Number(money.amount) / 100).toFixed(2);
}
```

### Styling (Tailwind CSS)

```tsx
// With Tailwind classes
<div className="max-w-md mx-auto p-6 bg-white rounded-lg shadow-lg">
  <h2 className="text-2xl font-bold mb-4">Cash Payment</h2>

  <div className="space-y-2 mb-6 p-4 bg-gray-50 rounded">
    <div className="flex justify-between">
      <span className="text-gray-600">Subtotal:</span>
      <span className="font-medium">${formatMoney(sale.subtotal)}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Tax:</span>
      <span className="font-medium">${formatMoney(sale.taxAmount)}</span>
    </div>
    <div className="flex justify-between text-xl font-bold pt-2 border-t">
      <span>Total:</span>
      <span>${formatMoney(sale.total)}</span>
    </div>
  </div>

  {/* ... rest of component */}
</div>
```

---

## Implementation Steps

1. Create `CashPayment.tsx` component
2. Add order summary display (subtotal, tax, total)
3. Create amount tendered input field
4. Implement real-time change calculation
5. Add quick amount buttons ($20, $50, $100, Exact)
6. Add validation (amount >= total)
7. Implement ProcessPayment mutation
8. Add loading state during API call
9. Create success modal/screen
10. Add error handling
11. Add keyboard support (Enter to submit)
12. Style with Tailwind CSS
13. Write component tests
14. Manual testing with various amounts

---

## Testing

### Component Tests

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { CashPayment } from './CashPayment';

const mockSale = {
  id: '123',
  subtotal: { amount: 1000n, currencyCode: 'USD' },
  taxAmount: { amount: 88n, currencyCode: 'USD' },
  total: { amount: 1088n, currencyCode: 'USD' },
};

describe('CashPayment', () => {
  it('calculates change correctly', () => {
    render(<CashPayment sale={mockSale} onComplete={() => {}} />);

    const input = screen.getByPlaceholderText('0.00');
    fireEvent.change(input, { target: { value: '20.00' } });

    // Change should be $20.00 - $10.88 = $9.12
    expect(screen.getByText('$9.12')).toBeInTheDocument();
  });

  it('shows insufficient for low amount', () => {
    render(<CashPayment sale={mockSale} onComplete={() => {}} />);

    const input = screen.getByPlaceholderText('0.00');
    fireEvent.change(input, { target: { value: '5.00' } });

    expect(screen.getByText('Insufficient')).toBeInTheDocument();
  });

  it('quick amount button works', () => {
    render(<CashPayment sale={mockSale} onComplete={() => {}} />);

    fireEvent.click(screen.getByText('$20'));

    expect(screen.getByDisplayValue('20.00')).toBeInTheDocument();
  });
});
```

### Manual Test Cases

**Test 1: Successful payment**
```
1. Create sale with total $10.88
2. Enter amount tendered: $20.00
3. Verify change shows: $9.12
4. Click "Complete Payment"
5. Verify success screen appears
6. Verify change amount displayed
```

**Test 2: Insufficient payment**
```
1. Create sale with total $10.88
2. Enter amount tendered: $5.00
3. Verify "Insufficient" message shown
4. Verify submit button disabled
```

**Test 3: Quick amount buttons**
```
1. Click "$20" button
2. Verify input shows 20.00
3. Verify change calculated
```

---

## Time Estimate

**Estimated**: 3 hours (component) + 1 hour (styling) + 1 hour (testing)
**Actual**: ___ hours

---

## Notes

- Use cents (BigInt) for API calls to avoid float precision errors
- Auto-focus on input for quick keyboard entry
- Quick buttons improve speed for common amounts
- Consider cash drawer integration (future)
- Print receipt after successful payment (future)
- Consider barcode scanner for payment cards (future)
- Keyboard shortcuts: Enter=Submit, Esc=Clear

---

## Related Stories

- **S1.10**: Process Cash Payment (backend API)
- **S1.12**: Item List Component (builds order)
- **S1.14**: Kitchen Display UI (triggered after payment)
- **S2.9**: Card Payment UI (similar flow for cards)
