# S1.8: Generate Code from Protos

**Sprint**: 1
**Story Points**: 2
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.4, S1.5, S1.6, S1.7 (All proto contracts defined)

---

## User Story

As a **developer**, I want to **generate Go and TypeScript code from proto definitions** so that **both backend and frontend have type-safe clients and servers ready for implementation**.

---

## Description

Run the Buf CLI code generation to create Go and TypeScript code from all proto definitions. This validates that all proto files are correct and provides the foundation code that both teams will use. The generated code includes ConnectRPC clients, servers, and type definitions.

This is a critical milestone that enables parallel development - frontend can start building UI with type-safe API clients, and backend can implement services with generated interfaces.

---

## Acceptance Criteria

### Code Generation Success
- [ ] All proto files pass lint validation
- [ ] Go code generated successfully
- [ ] TypeScript code generated successfully
- [ ] No compilation errors in Go code
- [ ] No TypeScript type errors
- [ ] Generated files in correct directories

### Generated Go Code
- [ ] Files in `gen/proto/go/common/v1/`
- [ ] Files in `gen/proto/go/item/v1/`
- [ ] Files in `gen/proto/go/order/v1/`
- [ ] Files in `gen/proto/go/platform/v1/`
- [ ] ConnectRPC service interfaces generated
- [ ] Message structs generated

### Generated TypeScript Code
- [ ] Files in `frontend/src/gen/common/v1/`
- [ ] Files in `frontend/src/gen/item/v1/`
- [ ] Files in `frontend/src/gen/order/v1/`
- [ ] Files in `frontend/src/gen/platform/v1/`
- [ ] ConnectRPC client code generated
- [ ] Type definitions generated

---

## Definition of Done

- [x] `make proto-lint` passes with no errors
- [x] `make proto-generate` completes successfully
- [x] All Go generated files compile
- [x] All TypeScript generated files have valid types
- [x] Generated code committed to repo
- [x] Both developers verified generation works
- [x] Documentation updated with generation commands
- [x] Code reviewed and approved

---

## Technical Details

### Expected Generated Files

**Go Files**:
```
gen/proto/go/
├── common/v1/
│   ├── money.pb.go
│   ├── localized_string.pb.go
│   ├── types.pb.go
│   └── *.connect.go
├── item/v1/
│   ├── item_service.pb.go
│   └── item_serviceconnect.go
├── order/v1/
│   ├── order_service.pb.go
│   └── order_serviceconnect.go
└── platform/v1/
    ├── platform_service.pb.go
    └── platform_serviceconnect.go
```

**TypeScript Files**:
```
frontend/src/gen/
├── common/v1/
│   ├── money_pb.ts
│   ├── localized_string_pb.ts
│   └── types_pb.ts
├── item/v1/
│   ├── item_service_pb.ts
│   └── item_service_connect.ts
├── order/v1/
│   ├── order_service_pb.ts
│   └── order_service_connect.ts
└── platform/v1/
    ├── platform_service_pb.ts
    └── platform_service_connect.ts
```

### Verification Tests

**Go Verification**:
```go
// Test that generated types compile
package main

import (
    commonv1 "github.com/modernpos/pos/gen/proto/go/common/v1"
    itemv1 "github.com/modernpos/pos/gen/proto/go/item/v1"
    orderv1 "github.com/modernpos/pos/gen/proto/go/order/v1"
    platformv1 "github.com/modernpos/pos/gen/proto/go/platform/v1"
)

func main() {
    // Test common types
    _ = &commonv1.Money{Amount: 1000, CurrencyCode: "USD"}
    _ = &commonv1.LocalizedString{Translations: map[string]string{"en-US": "Hello"}}

    // Test service types
    _ = &itemv1.Item{}
    _ = &orderv1.Sale{}
    _ = &platformv1.User{}

    println("All generated Go types compile successfully")
}
```

**TypeScript Verification**:
```typescript
// Test that generated types work
import { Money } from '@/gen/common/v1/money_pb';
import { LocalizedString } from '@/gen/common/v1/localized_string_pb';
import { Item } from '@/gen/item/v1/item_service_pb';
import { Sale } from '@/gen/order/v1/order_service_pb';
import { User } from '@/gen/platform/v1/platform_service_pb';

// Test instantiation
const money: Money = {
  amount: BigInt(1000),
  currencyCode: 'USD',
};

const name: LocalizedString = {
  translations: { 'en-US': 'Coffee' },
};

console.log('All generated TypeScript types work successfully');
```

---

## Implementation Steps

1. Ensure all proto files exist in correct locations:
   ```bash
   ls proto/common/v1/*.proto
   ls proto/item/v1/*.proto
   ls proto/order/v1/*.proto
   ls proto/platform/v1/*.proto
   ```

2. Run lint validation:
   ```bash
   make proto-lint
   # Fix any errors found
   ```

3. Clean previous generated code:
   ```bash
   make proto-clean
   ```

4. Generate new code:
   ```bash
   make proto-generate
   ```

5. Verify Go code generation:
   ```bash
   ls -la gen/proto/go/common/v1/
   ls -la gen/proto/go/item/v1/
   ls -la gen/proto/go/order/v1/
   ls -la gen/proto/go/platform/v1/
   ```

6. Verify TypeScript code generation:
   ```bash
   ls -la frontend/src/gen/common/v1/
   ls -la frontend/src/gen/item/v1/
   ls -la frontend/src/gen/order/v1/
   ls -la frontend/src/gen/platform/v1/
   ```

7. Test Go compilation:
   ```bash
   cd services/platform
   go mod tidy
   go build ./...
   ```

8. Test TypeScript compilation:
   ```bash
   cd frontend
   npm install
   npm run type-check
   ```

9. Create verification test files (optional but recommended)

10. Commit generated code:
    ```bash
    git add gen/ frontend/src/gen/
    git commit -m "Generate proto code for all services"
    ```

11. Update documentation with generation instructions

---

## Testing

### Manual Test Cases

**Test 1: Proto lint validation**
```bash
make proto-lint

# Expected: ✅ All files pass linting
# Expected: No style violations
```

**Test 2: Code generation**
```bash
make proto-generate

# Expected: ✅ Go code generated
# Expected: ✅ TypeScript code generated
# Expected: No errors or warnings
```

**Test 3: Go file count**
```bash
find gen/proto/go -name "*.pb.go" | wc -l
find gen/proto/go -name "*.connect.go" | wc -l

# Expected: Multiple .pb.go files (at least 7)
# Expected: Multiple .connect.go files (at least 3)
```

**Test 4: TypeScript file count**
```bash
find frontend/src/gen -name "*_pb.ts" | wc -l
find frontend/src/gen -name "*_connect.ts" | wc -l

# Expected: Multiple _pb.ts files
# Expected: Multiple _connect.ts files
```

**Test 5: Go compilation**
```bash
cd services/platform && go build ./...
cd services/item-management && go build ./...
cd services/order-fulfillment && go build ./...

# Expected: All compile successfully (may warn about no Go files yet)
```

**Test 6: TypeScript types**
```bash
cd frontend
npm run type-check

# Expected: No type errors
```

**Test 7: Import verification**
```bash
# Check that imports work
cd services/platform
go list -m github.com/modernpos/pos

# Expected: Shows module path
```

---

## Troubleshooting

### Issue: "buf: not found"
**Solution**: Install Buf CLI (see S1.3)

### Issue: "proto file not found"
**Solution**: Check proto file paths match buf.yaml configuration

### Issue: "go.mod: no such file"
**Solution**: Ensure monorepo is set up with go.work (see S1.1)

### Issue: "npm: cannot find module"
**Solution**: Run `npm install` in frontend directory

### Issue: "conflicting types"
**Solution**: Run `make proto-clean` then regenerate

---

## Time Estimate

**Estimated**: 1 hour (generation) + 1 hour (testing/verification)
**Actual**: ___ hours

---

## Notes

- Generated code should generally not be edited manually
- If proto changes, regenerate code with `make proto-generate`
- Consider adding generated code to `.gitignore` and generating in CI/CD (future)
- For MVP, committing generated code is acceptable
- ConnectRPC generates both server and client code
- Go uses interfaces for services, TypeScript uses functions
- All timestamps use protobuf Timestamp (converts to time.Time in Go, Date in TS)
- Money amounts use int64 in proto, BigInt in TypeScript

---

## Related Stories

- **S1.3**: Setup Buf CLI (prerequisite)
- **S1.4**: Define Proto Contracts - Common Types (input)
- **S1.5**: Define Proto Contracts - Item Service (input)
- **S1.6**: Define Proto Contracts - Order Service (input)
- **S1.7**: Define Proto Contracts - Platform Service (input)
- **S1.9**: Create Sale with Tax (uses generated code)
- **S1.10**: Process Cash Payment (uses generated code)
- **S1.12**: Item List Component (uses generated TypeScript)
