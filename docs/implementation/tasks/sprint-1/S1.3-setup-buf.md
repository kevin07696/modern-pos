# S1.3: Set Up Buf CLI

**Sprint**: 1
**Story Points**: 3
**Assignee**: Both
**Priority**: P0 - Critical
**Dependencies**: S1.1 (Setup Monorepo)

---

## User Story

As a **developer**, I want **Buf CLI configured for proto management** so that **I can generate type-safe client and server code from proto definitions**.

---

## Description

Set up the Buf CLI toolchain for managing Protocol Buffer definitions and generating ConnectRPC code. Buf provides modern tooling for proto files including linting, breaking change detection, and code generation for multiple languages (Go and TypeScript).

This setup enables contract-first development where proto files are the source of truth for API contracts, allowing frontend and backend developers to work in parallel.

---

## Acceptance Criteria

### Buf CLI Installation
- [ ] Buf CLI installed (v1.28+)
- [ ] Installation documented in README
- [ ] Verified with `buf --version`

### Buf Configuration Files
- [ ] `buf.yaml` created in proto directory
- [ ] `buf.gen.yaml` for code generation config
- [ ] `buf.work.yaml` for workspace management
- [ ] Linting rules configured
- [ ] Breaking change detection enabled

### Code Generation Targets
- [ ] Go code generation configured (ConnectRPC)
- [ ] TypeScript code generation configured (ConnectRPC)
- [ ] Generated code directories specified
- [ ] Go module path configured
- [ ] npm package configuration for TypeScript

### Makefile Integration
- [ ] `make proto-generate` command
- [ ] `make proto-lint` command
- [ ] `make proto-breaking` command
- [ ] All proto commands documented

---

## Definition of Done

- [x] Buf CLI installed and verified
- [x] buf.yaml configuration complete
- [x] buf.gen.yaml configuration complete
- [x] Can generate Go code from protos
- [x] Can generate TypeScript code from protos
- [x] Makefile targets work correctly
- [x] Proto linting passes
- [x] Documentation in README
- [x] CI/CD integration planned
- [x] Code reviewed and approved

---

## Technical Details

### Directory Structure

```
modern-pos/
├── proto/
│   ├── buf.yaml
│   ├── buf.gen.yaml
│   ├── buf.work.yaml
│   ├── common/
│   │   └── v1/
│   │       ├── money.proto
│   │       ├── localized_string.proto
│   │       └── pagination.proto
│   ├── platform/
│   │   └── v1/
│   │       └── platform_service.proto
│   ├── item/
│   │   └── v1/
│   │       └── item_service.proto
│   ├── order/
│   │   └── v1/
│   │       └── order_service.proto
│   └── communication/
│       └── v1/
│           └── communication_service.proto
└── Makefile
```

### buf.yaml Configuration

```yaml
version: v1
name: buf.build/modernpos/api
deps:
  - buf.build/connectrpc/connect:v1.12.0
breaking:
  use:
    - FILE
lint:
  use:
    - DEFAULT
  except:
    - PACKAGE_VERSION_SUFFIX
  enum_zero_value_suffix: _UNSPECIFIED
  rpc_allow_same_request_response: false
  rpc_allow_google_protobuf_empty_requests: false
  rpc_allow_google_protobuf_empty_responses: false
  service_suffix: Service
```

### buf.gen.yaml Configuration

```yaml
version: v1
managed:
  enabled: true
  go_package_prefix:
    default: github.com/modernpos/pos/gen/proto
plugins:
  # Go plugins
  - plugin: buf.build/protocolbuffers/go:v1.31.0
    out: gen/proto/go
    opt:
      - paths=source_relative

  - plugin: buf.build/connectrpc/go:v1.12.0
    out: gen/proto/go
    opt:
      - paths=source_relative

  # TypeScript plugins
  - plugin: buf.build/connectrpc/es:v1.1.0
    out: frontend/src/gen
    opt:
      - target=ts

  - plugin: buf.build/bufbuild/es:v1.5.0
    out: frontend/src/gen
    opt:
      - target=ts
```

### buf.work.yaml Configuration

```yaml
version: v1
directories:
  - proto
```

### Makefile Targets

```makefile
# Proto targets
.PHONY: proto-generate proto-lint proto-breaking proto-clean

proto-generate:
	@echo "Generating code from proto files..."
	cd proto && buf generate

proto-lint:
	@echo "Linting proto files..."
	cd proto && buf lint

proto-breaking:
	@echo "Checking for breaking changes..."
	cd proto && buf breaking --against '.git#branch=main'

proto-clean:
	@echo "Cleaning generated proto code..."
	rm -rf gen/proto/go/*
	rm -rf frontend/src/gen/*

# Combined target
proto: proto-lint proto-generate
```

---

## Implementation Steps

1. Install Buf CLI:
   ```bash
   # macOS
   brew install bufbuild/buf/buf

   # Linux
   curl -sSL "https://github.com/bufbuild/buf/releases/download/v1.28.1/buf-$(uname -s)-$(uname -m)" -o /usr/local/bin/buf
   chmod +x /usr/local/bin/buf

   # Verify
   buf --version
   ```

2. Create proto directory structure:
   ```bash
   mkdir -p proto/{common,platform,item,order,communication}/v1
   ```

3. Create `proto/buf.yaml` with module configuration

4. Create `proto/buf.gen.yaml` with generation plugins

5. Create `proto/buf.work.yaml` for workspace

6. Add Makefile targets for proto operations

7. Create `.gitignore` entries:
   ```
   /gen/proto/
   /frontend/src/gen/
   ```

8. Initialize buf module:
   ```bash
   cd proto && buf mod init
   ```

9. Test generation with empty proto (will fail - expected)

10. Document installation and usage in README

---

## Testing

### Manual Test Cases

**Test 1: Buf CLI installation**
```bash
buf --version

# Expected: v1.28.1 or newer
```

**Test 2: Buf configuration validation**
```bash
cd proto
buf lint

# Expected: No errors (will warn about missing files)
```

**Test 3: Code generation (after proto files exist)**
```bash
make proto-generate

# Expected: Go code in gen/proto/go/
# Expected: TypeScript code in frontend/src/gen/
```

**Test 4: Linting with actual proto files**
```bash
make proto-lint

# Expected: Passes all lint rules
```

**Test 5: Makefile targets**
```bash
make proto        # Should run lint + generate
make proto-clean  # Should remove generated code

# Expected: All targets execute without errors
```

---

## README Documentation

Add to project README:

```markdown
## Protocol Buffers Setup

### Install Buf CLI

**macOS**:
```bash
brew install bufbuild/buf/buf
```

**Linux**:
```bash
curl -sSL "https://github.com/bufbuild/buf/releases/download/v1.28.1/buf-$(uname -s)-$(uname -m)" -o /usr/local/bin/buf
chmod +x /usr/local/bin/buf
```

**Verify installation**:
```bash
buf --version  # Should be v1.28.1+
```

### Generate Code from Protos

```bash
# Lint proto files
make proto-lint

# Generate Go and TypeScript code
make proto-generate

# Or run both
make proto
```

### Proto File Structure

- `proto/common/v1/` - Shared types (Money, LocalizedString)
- `proto/platform/v1/` - Authentication, users, locations
- `proto/item/v1/` - Menu items, categories, modifiers
- `proto/order/v1/` - Sales, payments, orders
- `proto/communication/v1/` - Kitchen display, notifications

Generated code:
- Go: `gen/proto/go/`
- TypeScript: `frontend/src/gen/`
```

---

## Time Estimate

**Estimated**: 2 hours (setup) + 1 hour (testing)
**Actual**: ___ hours

---

## Notes

- Buf is faster and more reliable than protoc
- Managed mode automatically handles imports and dependencies
- ConnectRPC plugins generate both gRPC and gRPC-Web compatible code
- Breaking change detection requires git history
- Consider buf.build remote registry for proto sharing (future)
- Generated code should be gitignored, generated in CI/CD

---

## Related Stories

- **S1.1**: Setup Monorepo Structure (prerequisite)
- **S1.4**: Define Proto Contracts - Common Types (uses this setup)
- **S1.5**: Define Proto Contracts - Item Service (uses this setup)
- **S1.6**: Define Proto Contracts - Order Service (uses this setup)
- **S1.7**: Define Proto Contracts - Platform Service (uses this setup)
- **S1.8**: Generate Code from Protos (uses this setup)
